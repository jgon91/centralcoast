<!DOCTYPE html>
<html lang="en">
	<head>
		{% load staticfiles %}
		<script src="{% static 'js/jquery-1.11.2.min.js'%}"></script>
		<script>
			var item_count = 0;
			var urlTest = "{% url 'stopBreak' %}";
			$(document).ready(function() {
				$("#foot").load("{%url 'footer'%}");
				$("#head").load("{%url 'headerDriver'%}");
				
				getEmployeeShifts("{{ csrf_token }}", "{% url 'getEmployeeShifts' %}");

				$("#startShift").click(function() {
					var confirmResult = confirm("Are you sure?");
					if (confirmResult == true) {
						startShift("{{ csrf_token }}", "{% url 'startShift' %}");
					}
				});
				$(".btnBreaksGreen").click(function(){
					var confirmResult = confirm("Are you sure?");
					if (confirmResult == true) {
						startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", item_count);
					}	
				});	
				$(".btnBreaksRed").click(function(){
					var confirmResult = confirm("Are you sure?");
					if (confirmResult == true){
	   					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", item_count);
					}
				});
				$("#addBreak").click(function() {
					var confirmResult = confirm("Are you sure?");
					if (confirmResult == true) {
						createBtnBreak(item_count);
					}
				});
				$("#stopShift").click(function(){
					var confirmResult = confirm("Are you sure?");
					if (confirmResult == true){
   						stopShift("{{ csrf_token }}", "{% url 'stopShift' %}");
   					}
				});
			});
			function getEmployeeShifts(token, url) {
				$(addBreak).attr("disabled", "disabled");
				$(startBreak1).attr("disabled", "disabled");
				$(stopBreak1).attr("disabled", "disabled");
				$.ajax({
					method : "POST",
					url : url,
					data : {
						"csrfmiddlewaretoken" : token
					},
					datatype : "json",
					success : function(data, status, xhr) {
						if (data.success) {
							if (data.hour_started != "") {
								changeBtn("#startShift", data.hour_started.substring(0,8));
							}
							for(var i = 0; i < data.breaks.length; i++) {
								if (data.breaks[i][0] != "None") {
									changeBtn("#startBreak" + i, data.breaks[i][0].substring(0, 8));
									$(addBreak).attr("disabled", "disabled");
								}
								if (data.breaks[i][1] != "None") {
									changeBtn("#stopBreak" + i, data.breaks[i][1].substring(0, 8));
									if (data.breaks[0][1] != "None") {
										$(startBreak1).removeAttr('disabled');
										$(stopBreak1).removeAttr('disabled');
									}
									if (data.breaks[1][1] != "None") {
										$(addBreak).removeAttr('disabled');
									}
									if (data.breaks[1][1] != "None" && i > 0 && i < data.breaks.length-1) {
										createBtnBreak(i+1);
									}
									item_count++;
								}
							}
							if (data.hour_ended != "None") {
								changeBtn("#stopShift", data.hour_ended.substring(0,8));
								$(addBreak).attr("disabled", "disabled");
							}
						}
					}
				});
			}
			function startShift(token, url) {
				$.ajax({
					method : "POST",
					url : url,
					data : {
						"csrfmiddlewaretoken" : token
					},
					datatype : "json",
					success : function(data, status, xhr) {
						if (data.success) {
							changeBtn("#startShift", data.hour_started.substring(11,19));
						} else if (data.code == 1) {
							alert("The shift for today was already created.");
						} else if (data.code == 2) {
							alert("There is no users associated whit this id.");
						} else if (data.code == 3) {
							alert("Error. Contact Suport.");
						} else if (data.code == 4) {
							alert("Error. Contact Suport.");
						}
					}
				});
			}
			function startBreak(token, url, breaks) {
				$.ajax({
					method : "POST",
					url : url,
					data : {
						"csrfmiddlewaretoken" : token
					},
					datatype : "json",
					success : function(data, status, xhr) {
						if (data.success) {
							changeBtn("#startBreak" + breaks, data.time.substring(11,19));
						} else if (data.code == 1) {
							alert("You cannot start 2 breaks at the same time.");
						} else if (data.code == 2) {
							alert("The shift for today was already finished.");
						} else if (data.code == 3) {
							alert("You need to start a shift first.");
						} else if (data.code == 4) {
							alert("Error. Contact Suport.");
						} else if (data.code == 5) {
							alert("Error. Contact Suport.");
						}
					}
				});
			}
			function stopBreak(token, url, breaks) {
					$.ajax({
						method: "POST",
						url: url,
						data: {"csrfmiddlewaretoken": token},
						datatype: "json",
						success: function(data, status, xhr){
							if(data.success){
								changeBtn("#stopBreak" + breaks, data.time.substring(11,19));
								if(breaks == 0){	
									$(startBreak1).removeAttr('disabled');
									$(stopBreak1).removeAttr('disabled');
								}
								if(breaks >= 1){	
									$(addBreak).removeAttr('disabled');
								}
								item_count++;
							} else if(data.code == 1){
								alert("You need to start a break first.");
							} else if(data.code == 2){
								alert("The shift for today was already finished.");
							} else if(data.code == 3){
								alert("You need to start a shift first.");
							} else if(data.code == 4){
								alert("Error. Contact Suport.");
							} else if(data.code == 5){
								alert("Error. Contact Suport.");
							}
						}
					});
			}
			function stopShift(token, url) {
					$.ajax({
						method: "POST",
						url: url,
						data: {"csrfmiddlewaretoken": token},
						datatype: "json",
						success: function(data, status, xhr){
							if(data.success){
								changeBtn("#stopShift", data.hour_ended.substring(11,19));
							} else if(data.code == 1){
								alert("You need to have done at least 3 breaks.");
							} else if(data.code == 2){
								alert("The shift for today was already finished.");
							} else if(data.code == 3){
								alert("You need to start a shift first.");
							} else if(data.code == 4){
								alert("There is no users associated with this id.");
							} else if(data.code == 5){
								alert("Error. Contact Suport.");
							} else if(data.code == 6){
								alert("Error. Contact Suport.");
							}
						}
					});
			}
			function changeBtn(idBtn, hour) {
				$(idBtn).attr("value", hour);
				$(idBtn).attr("disabled", "disabled");
  				$(idBtn).css('background', 'url("{% static 'imgSmall/buttons/startShiftHover.png' %}") no-repeat top left');
  				$(idBtn).css('background-size', '100% 100%');
  				$(idBtn).css('font-size', '25px');
			}
			function createBtnBreak(count) {
				$(addBreak).attr("disabled", "disabled");
				$( "#divBreaks").append('<div class="row"><div class="col-xs-1 col-md-1 btnColTime"></div><div class="col-xs-4 col-md-4 btnColTime"><input type="button" id="startBreak'+count+'" value="START BREAK" class="btnGreen btnBreaksGreen"/></div><div class="col-xs-2 col-md-2 btnColTime"></div><div class="col-xs-4 col-md-4 btnColTime"><input type="button" id="stopBreak'+count+'" value="STOP BREAK"  class="btnRed btnBreaksRed"/></div><div class="col-xs-1 col-md-1 btnColTime"></div></div>');
				$(".btnBreaksGreen").click(function() {
					var confirmResult = confirm("Are you sure?");
					if (confirmResult == true) {
						startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", item_count);
					}
				});
				$(".btnBreaksRed").click(function(){
					var confirmResult = confirm("Are you sure?");
					if (confirmResult == true){
						stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", item_count);
					}
				});
			}
		</script>
	</head>
	<body>
		<header id="head"></header>
		<div id="wrapper">
			<div id="content">
				<div class="namePage">
					<img src="{% static 'imgSmall/clock.png' %}"/>
					HC TIMEKEEPER
				</div>
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="startShift" value="START SHIFT"/>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-1 col-md-1 btnColTime">
					</div>
					<div class="col-xs-4 col-md-4 btnColTime">
						<input type="button" id="startBreak0" value="START BREAK" class="btnGreen btnBreaksGreen"/>
					</div>
					<div class="col-xs-2 col-md-2 btnColTime">
					</div>
					<div class="col-xs-4 col-md-4 btnColTime">
						<input type="button" id="stopBreak0" value="STOP BREAK"  class="btnRed btnBreaksRed"/>
					</div>
					<div class="col-xs-1 col-md-1 btnColTime">
					</div>
				</div>
				<div class="row">
					<div class="col-xs-1 col-md-1 btnColTime">
					</div>
					<div class="col-xs-4 col-md-4 btnColTime">
						<input type="button" id="startBreak1" value="START LUNCH" class="btnGreen btnBreaksGreen"/>
					</div>
					<div class="col-xs-2 col-md-2 btnColTime">
					</div>
					<div class="col-xs-4 col-md-4 btnColTime">
						<input type="button" id="stopBreak1" value="STOP LUNCH" class="btnRed btnBreaksRed"/>
					</div>
					<div class="col-xs-1 col-md-1 btnColTime">
					</div>
				</div>
				<div id="divBreaks"></div>
				<div class="row">
					<div class="col-xs-1 col-md-1 btnColTime">
					</div>
					<div class="col-xs-4 col-md-4 btnColTime">
						<input type="button" id="addBreak" value="   ADD BREAK" />
					</div>
					<div class="col-xs-2 col-md-2 btnColTime">
					</div>
					<div class="col-xs-4 col-md-4 btnColTime">
					</div>
					<div class="col-xs-1 col-md-1 btnColTime">
					</div>
				</div>
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="stopShift" value="END SHIFT"/>
					</div>
				</div>
			</div>
		</div>	
		<footer>
				&copy;2015 Heavy Connect, Inc.
			</footer>
	</body>
</html>
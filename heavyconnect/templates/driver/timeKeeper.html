<!DOCTYPE html>
<html lang="en">
	<head>
		{% load staticfiles %}
		{% load i18n %}
		<script src="{% static 'js/jquery-1.11.2.min.js'%}"></script>
		<script src="{% static 'jSignature/jSignature.min.js'%}"></script>
		<script>
		var item_count = 0;
		var hour_start = 0;
		$(document).ready(function() {
			$("#foot").load("{%url 'footer'%}");
			$("#head").load("{%url 'headerDriver'%}");
			$("#signature").jSignature()
			$("#clearSignature").click(function() {
			var $sigdiv = $("#signature");
				$sigdiv.jSignature("reset");
			});

			$("#taskFlowSubmit").click(function() {
				$('#signModal').modal();
			});

			$("#start-shift").blur(function() {
			    var enteredDatetime = getAdjustedDatetime("start-shift");
				var enteredTime = getAdjustedTime("start-shift");
    			startShift("{{ csrf_token }}", "{% url 'startShift' %}", enteredDatetime, "start-shift", enteredTime);
			});

			$("#stop-shift").blur(function() {
				var enteredDatetime = getAdjustedDatetime("stop-shift");
				var enteredTime = getAdjustedTime("stop-shift");
    			stopShift("{{ csrf_token }}", "{% url 'stopShift' %}", enteredDatetime, "stop-shift", enteredTime);
			});


			$("#start-break0").blur(function() {
					var enteredDatetime = getAdjustedDatetime("start-break0");
					var enteredTime = getAdjustedTime("start-break0");
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 0, enteredDatetime, "start-break0", enteredTime);
			});

			$("#start-break1").blur(function() {
					var enteredDatetime = getAdjustedDatetime("start-break1");
					var enteredTime = getAdjustedTime("start-break1");
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 1, enteredDatetime, "start-break1", enteredTime);
			});

			$("#start-break2").blur(function() {
					var enteredDatetime = getAdjustedDatetime("start-break2");
					var enteredTime = getAdjustedTime("start-break2");
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 2, enteredDatetime, "start-break2", enteredTime);
			});

			$("#start-break3").blur(function() {
					var enteredDatetime = getAdjustedDatetime("start-break3");
					var enteredTime = getAdjustedTime("start-break3");
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 3, enteredDatetime, "start-break3", enteredTime);
			});

			$("#start-break4").blur(function() {
					var enteredDatetime = getAdjustedDatetime("start-break4");
					var enteredTime = getAdjustedTime("start-break4");
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 4, enteredDatetime, "start-break4", enteredTime);
			});

			$("#start-break5").blur(function() {
					var enteredDatetime = getAdjustedDatetime("start-break5");
					var enteredTime = getAdjustedTime("start-break5");
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 5, enteredDatetime, "start-break5", enteredTime);
			});

			function getAdjustedDatetime(id){

				datetime = getDate() +" "+document.getElementById(id).value;
				return datetime;
			}

			function getAdjustedTime(id){
				return document.getElementById(id).value;
			}

			$("#stop-break0").blur(function() {
					var enteredDatetime = getAdjustedDatetime("stop-break0");
					var enteredTime = getAdjustedTime("stop-break0");
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 0, enteredDatetime, "stop-break0", enteredTime);
			});

			$("#stop-break1").blur(function() {
					var enteredDatetime = getAdjustedDatetime("stop-break1");
					var enteredTime = getAdjustedTime("stop-break1");
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 1, enteredDatetime, "stop-break1", enteredTime);
			});

			$("#stop-break2").blur(function() {
					var enteredDatetime = getAdjustedDatetime("stop-break2");
					var enteredTime = getAdjustedTime("stop-break2");
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 2, enteredDatetime,"stop-break2", enteredTime);
			});

			$("#stop-break3").blur(function() {
					var enteredDatetime = getAdjustedDatetime("stop-break3");
					var enteredTime = getAdjustedTime("stop-break3");
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 3, enteredDatetime, "stop-break3", enteredTime);
			});

			$("#stop-break4").blur(function() {
					var enteredDatetime = getAdjustedDatetime("stop-break4");
					var enteredTime = getAdjustedTime("stop-break4");
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 4, enteredDatetime, "stop-break4", enteredTime);
			});

			$("#stop-break5").blur(function() {
					var enteredDatetime = getAdjustedDatetime("stop-break5");
					var enteredTime = getAdjustedTime("stop-break5");
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 5, enteredDatetime, "stop-break5", enteredTime);
			});


			$("#stopBreak0").click(function(){
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 0, getTimeNow(), "stop-break0", getTime());
			});

			$("#stopBreak1").click(function(){
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 1, getTimeNow(), "stop-break1", getTime());
			});

			$("#stopBreak2").click(function(){
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 2, getTimeNow(), "stop-break2", getTime());
			});

			$("#stopBreak3").click(function(){
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 3, getTimeNow(), "stop-break3", getTime());
			});
			$("#stopBreak4").click(function(){
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 4, getTimeNow(), "stop-break4", getTime());
			});
			$("#stopBreak5").click(function(){
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", 5, getTimeNow(), "stop-break5", getTime());
			});

			$("#startBreak0").click(function(){
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 0, getTimeNow(), "start-break0", getTime());
			});

			$("#startBreak1").click(function(){
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 1, getTimeNow(), "start-break1", getTime());
			});

			$("#startBreak2").click(function(){
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 2, getTimeNow(), "start-break2", getTime());
			});

			$("#startBreak3").click(function(){
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 3, getTimeNow(), "start-break3", getTime());
			});
			$("#startBreak4").click(function(){
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 4, getTimeNow(), "start-break4", getTime());
			});
			$("#startBreak5").click(function(){
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", 5, getTimeNow(), "start-break5", getTime());
			});

			getEmployeeShifts("{{ csrf_token }}", "{% url 'getEmployeeShifts' %}");

			$("#startShift").click(function() {
				startShift("{{ csrf_token }}", "{% url 'startShift' %}", getTimeNow(), "start-shift", getTime());

			});

			$("#stopShift").click(function(){
				stopShift("{{ csrf_token }}", "{% url 'stopShift' %}", getTimeNow(), "stop-shift", getTime());

			});

			$("#stopShiftConfirm").click(function(){
				var $sigdiv = $("#signature");
				var datapair = $sigdiv.jSignature("getData", "base30");
				updateSignature("{{ csrf_token }}", "{% url 'updateSignature' %}", datapair[1]);

			});
		});

		function timeNow(i, time) {
  			document.getElementById(i).value = time;
		}

		function getTime() {
			var d = new Date(),
      		h = (d.getHours()<10?'0':'') + d.getHours(),
      		m = (d.getMinutes()<10?'0':'') + d.getMinutes();
      		return h + ":" + m
		}

		function getDate() {

			var d = new Date(),
      		h = (d.getHours()<10?'0':'') + d.getHours(),
      		m = (d.getMinutes()<10?'0':'') + d.getMinutes(),
      		s = (d.getSeconds()<10?'0':'') + d.getSeconds(),
      		y = d.getFullYear(),
      		M = (d.getMonth()<10?'0':'') + (d.getMonth()+1),
      		D = (d.getDate()<10?'0':'') + d.getDate();
      		return y + "-" + M + "-" + D

		}
		function getTimeNow() {

			var d = new Date(),
      		h = (d.getHours()<10?'0':'') + d.getHours(),
      		m = (d.getMinutes()<10?'0':'') + d.getMinutes(),
      		s = (d.getSeconds()<10?'0':'') + d.getSeconds(),
      		y = d.getFullYear(),
      		M = (d.getMonth()<10?'0':'') + (d.getMonth()+1),
      		D = (d.getDate()<10?'0':'') + d.getDate();
      		return y + "-" + M + "-" + D + " " + h + ":" + m
		}

		function updateSignature(token, url, signature) {
			$.ajax({
				method : "POST",
				url : url,
				data : {"csrfmiddlewaretoken" : token, "signature": signature},
				datatype : "json",
				success : function(data, status, xhr) {
					if (data.success) {

					} else if (data.code == 2) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("There is already a signature for this shift");
					} else if (data.code == 3) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("You have not started a shift yet");
					}
				}
			});
		}

		function getEmployeeShifts(token, url) {
			$.ajax({
				method : "POST",
				url : url,
				data : {"csrfmiddlewaretoken" : token},
				datatype : "json",
				success : function(data, status, xhr) {
					if (data.success) {
						if (data.hour_started != 'None') {
							document.getElementById("start-shift").value = data.hour_started.substring(0,8);
						}

						for(var i = 0; i < data.breaks.length; i++) {
							if (data.breaks[i][0] != "None") {
								document.getElementById("start-break"+i).value = data.breaks[i][0].substring(0, 8);
							}
							if (data.breaks[i][1] != "None") {
								document.getElementById("stop-break"+i).value = data.breaks[i][1].substring(0, 8);
							}

						}

						if (data.hour_ended != "None") {
							document.getElementById("stop-shift").value = data.hour_ended.substring(0,8);

						}
					} else if (data.code == 1) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("There is no shift records for this employee.");
					} else if (data.code == 2) {
							$('#showTimekeeperModal').modal();
							$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if (data.code == 3) {
							$('#showTimekeeperModal').modal();
							$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function startShift(token, url, currentDate, startShiftId, time) {
			$.ajax({
				method : "POST",
				url : url,
				data : {
					"csrfmiddlewaretoken" : token,
					"currentTime" : currentDate
				},
				datatype : "json",
				success : function(data, status, xhr) {
					if (data.success) {
						timeNow(startShiftId, time);
					} else if (data.code == 1) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("You need to finish the shift you started already before create a new one.");
						document.getElementById("start-shift").value = "";

					} else if (data.code == 2) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("There is no users associated whit this id.");
					} else if (data.code == 3) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if (data.code == 4) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function startBreak(token, url, breaks, currentDate, breakId, time) {
			$.ajax({
				method : "POST",
				url : url,
				data : {"csrfmiddlewaretoken" : token,
						"currentTime" : currentDate,
						"breakNumber" : breaks,
				},
				datatype : "json",
				success : function(data, status, xhr) {
					if (data.success) {
						timeNow(breakId, time);
					} else if (data.code == 3) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("You need to start a shift first.");
						document.getElementById(breakId).value = "";

					} else if (data.code == 4) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if (data.code == 5) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function stopBreak(token, url, breaks, currentDate, breakId, time) {
			$.ajax({
				method: "POST",
				url: url,
				data: {"csrfmiddlewaretoken": token,
						"currentTime": currentDate,
						"breakNumber" : breaks,
				},
				datatype: "json",
				success: function(data, status, xhr){
					if(data.success){
						timeNow(breakId, time);
					} else if(data.code == 3){
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("You need to start a shift first.");
						document.getElementById(breakId).value = "";
					} else if(data.code == 4){
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if(data.code == 5){
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function stopShift(token, url, currentDate, stopShiftId, time) {
			$.ajax({
				method: "POST",
				url: url,
				data: {"csrfmiddlewaretoken": token,
						"currentTime": currentDate
				},
				datatype: "json",
				success: function(data, status, xhr){
					if(data.success){
						timeNow(stopShiftId, time);
					} else if(data.code == 3){
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("You have not started your shift yet.");
						document.getElementById("stop-shift").value = "";
					} else if(data.code == 4){
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("This user is not authorized to use the system.");
					} else if(data.code == 5){
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if(data.code == 6){
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}


		</script>
	</head>
	<body>
		<header id="head"></header>
		<div id="wrapper">
			<div id="content">
				<div class="namePage">
					<img src="{% static 'imgSmall/iconTimekeeper.png' %}"/>
					{% trans 'HC TIMEKEEPER' %}
				</div>
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="startShift" value="{% trans 'START SHIFT' %}" />
						<input type="time" id="start-shift" id="startShiftInput"/>

					</div>
				</div>
				<div class="form-inline row">
					<div class="form-group">
						<label for="startBreak0">1st Break:</label>
						<input type="button" id="startBreak0" value="{% trans 'START' %}" class="btnGreenTime btnBreaksGreen" />
						<input type="time" id="start-break0" />
						<input type="button" id="stopBreak0" value="{% trans 'STOP' %}"  class="btnRedTime btnBreaksRed"/>
						<input type="time" id="stop-break0" />
					</div>
				</div>
				<div class="form-inline row">
					<div class="form-group">
						<label for="startBreak1">1st Lunch:</label>
						<input type="button" id="startBreak1" value="{% trans 'START' %}" class="btnGreenTime btnBreaksGreen" />
						<input type="time" id="start-break1" />
						<input type="button" id="stopBreak1" value="{% trans 'STOP' %}"  class="btnRedTime btnBreaksRed"/>
						<input type="time" id="stop-break1" />
					</div>
				</div>
				<div class="form-inline row">
					<div class="form-group">
						<label for="startBreak2">2nd Break:</label>
						<input type="button" id="startBreak2" value="{% trans 'START' %}" class="btnGreenTime btnBreaksGreen"/>
						<input type="time" id="start-break2" />
						<input type="button" id="stopBreak2" value="{% trans 'STOP' %}"  class="btnRedTime btnBreaksRed"/>
						<input type="time" id="stop-break2" />
					</div>
				</div>
				<div class="form-inline row">
					<div class="form-group">
						<label for="startBreak3">2nd Lunch:</label>
						<input type="button" id="startBreak3" value="{% trans 'START' %}" class="btnGreenTime btnBreaksGreen"/>
						<input type="time" id="start-break3" />
						<input type="button" id="stopBreak3" value="{% trans 'STOP' %}"  class="btnRedTime btnBreaksRed"/>
						<input type="time" id="stop-break3" />
					</div>
				</div>
				<div class="form-inline row">
					<div class="form-group">
						<label for="startBreak4">3rd Break:</label>
						<input type="button" id="startBreak4" value="{% trans 'START' %}" class="btnGreenTime btnBreaksGreen"/>
						<input type="time" id="start-break4" />
						<input type="button" id="stopBreak4" value="{% trans 'STOP' %}"  class="btnRedTime btnBreaksRed"/>
						<input type="time" id="stop-break4" />
					</div>
				</div>
				<div class="form-inline row">
					<div class="form-group">
						<label for="startBreak5">4th Break:</label>
						<input type="button" id="startBreak5" value="{% trans 'START' %}" class="btnGreenTime btnBreaksGreen" />
						<input type="time" id="start-break5" />
						<input type="button" id="stopBreak5" value="{% trans 'STOP' %}"  class="btnRedTime btnBreaksRed"/>
						<input type="time" id="stop-break5" />
					</div>
				</div>

				<div id="divBreaks"></div>
				<div class="form-inline row">
					<div class="form-group">
						<input type="button" id="stopShift" value="{% trans 'END SHIFT' %}" />
						<input type="time" id="stop-shift" />
					</div>
					<div class="form-inline row">
					<a href="#"><input type="button" class="btnSubmitTF" value="SUBMIT" id="taskFlowSubmit"></a>
				</div>
				</div>


			</div>
		</div>
		<footer>
			&copy;2015 Heavy Connect, Inc.
		</footer>
		<div id="clearBoth"></div>
		<!-- MODAL OF ALERT - TIMEKEEPER -->
		<div class="modal fade" id="showTimekeeperModal" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content modalTimekeeper">
					<div class="modal-body">
						<button type="button" class="closeEquip" data-dismiss="modal"></button>
						<span id="messageTimekeeper"></span>
						<br>
						<div class="both"></div>
					</div>
				</div>
			</div>
		</div>
		<div id="clearBoth"></div>
		<!-- MODAL SIGNATURE - TIMEKEEPER -->
		<div class="modal fade" id="signModal" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content signModalDialog">
					<div class="modal-title" id="titleSign">{% trans 'Sign Here' %}</div>
					<div class="modal-body" id="signatureContent">

					<div id="signField" >
						<div id="signature"></div>
						<div style="margin-top: 75px;">
						<button type="button" id="clearSignature" class="btn btn-default">{% trans 'Limpiar' %}</button>
						<a href="">
							<button type="button" id="stopShiftConfirm" class="btn btn-success">
								{% trans 'Confirmar' %}
							</button>
						</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
<!DOCTYPE html>
<html lang="en">
	<head>
		{% load staticfiles %}
		{% load i18n %}
		<script src="{% static 'js/jquery-1.11.2.min.js'%}"></script>
		<script src="{% static 'jSignature/jSignature.min.js'%}"></script>
		<script>
		var item_count = 0;
		var hour_start = 0;
		var shiftStarted = 0;
		var breakStarted = 0;
		var lunchStarted = 0;
		var breakOrLunch = 0;	//	1 = break ... 2 = lunch
		
		var urlTest = "{% url 'stopBreak' %}";
		$(document).ready(function() {
			$("#foot").load("{%url 'footer'%}");
			$("#head").load("{%url 'headerDriver'%}");
			$("#signature").jSignature()
			$("#clearSignature").click(function() {
			var $sigdiv = $("#signature");
				$sigdiv.jSignature("reset");
			});
			getEmployeeShifts("{{ csrf_token }}", "{% url 'getEmployeeShifts' %}");
			
			$("#shift").click(function() {
				$('#showTimekeeperModal').modal();
				if (shiftStarted == 0) {
					$("#messageTimekeeper").html("Clock-in?");
				} else {
					$("#messageTimekeeper").html("Clock-out?");
				}
				$("#confirmShift").empty();
				$("#confirmBreak").empty();
				$("#confirmLunch").empty();
				$("#confirmShift").append('<input type="button" value="{% trans 'CONFIRM' %}" class="btnsTimekeeper"/>');
			});
			$("#confirmShift").click(function() {
				if (shiftStarted == 0) {
					$("#messageTimekeeper").html("Starting shift...");
					$('#confirmShift').hide();
					startShift("{{ csrf_token }}", "{% url 'startShift' %}");
				} else {
					$("#messageTimekeeper").html("Stopping shift...");
					$('#confirmShift').hide();
					alert("stop shift");
					//stopShift("{{ csrf_token }}", "{% url 'stopShift' %}");
				}
			});
			$("#break").click(function() {
				$('#showTimekeeperModal').modal();
				if (breakStarted == 0) {
					$("#messageTimekeeper").html("Start break?");
				} else {
					$("#messageTimekeeper").html("End break?");
				}
				$("#confirmShift").empty();
				$("#confirmBreak").empty();
				$("#confirmLunch").empty();
				$("#confirmBreak").append('<input type="button" value="{% trans 'CONFIRM' %}" class="btnsTimekeeper"/>');
			});
			$("#confirmBreak").click(function() {
				breakOrLunch = 1;
				if (breakStarted == 0) {
					$("#messageTimekeeper").html("Starting break...");
					$('#confirmBreak').hide();
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", item_count);
				} else {
					$("#messageTimekeeper").html("Ending break...");
					$('#confirmBreak').hide();
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", item_count);
				}
				breakOrLunch = 0;
			});
			$("#lunch").click(function() {
				$('#showTimekeeperModal').modal();
				if (lunchStarted == 0) {
					$("#messageTimekeeper").html("Start lunch?");
				} else {
					$("#messageTimekeeper").html("End lunch?");
				}
				$("#confirmShift").empty();
				$("#confirmBreak").empty();
				$("#confirmLunch").empty();
				$("#confirmLunch").append('<input type="button" value="{% trans 'CONFIRM' %}" class="btnsTimekeeper"/>');
			});
			$("#confirmLunch").click(function() {
				if (lunchStarted == 0) {
					$("#messageTimekeeper").html("Starting lunch...");
					$('#confirmLunch').hide();
					breakOrLunch = 2;
					startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", item_count);
					breakOrLunch = 0;
				} else {
					$("#messageTimekeeper").html("Ending lunch...");
					$('#confirmLunch').hide();
					breakOrLunch = 2;
					stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", item_count);
					breakOrLunch = 0;
				}
			});
			
			
			
			
			$(".btnBreaksGreen").click(function(){
				startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", item_count);
			});
			$(".btnBreaksRed").click(function(){
				stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", item_count);
			});
			$("#stopBreak").click(function() {
				createBtnBreak(item_count);
			});
			$("#stopShift").click(function(){
				//$('#signModal').modal();
				//var $sigdiv = $("#signature");
				//Get the signature in the 64base
				//var datapair = $sigdiv.jSignature("getData", "base30");
				stopShift("{{ csrf_token }}", "{% url 'stopShift' %}");
			});
		});
		function getEmployeeShifts(token, url) {
			$.ajax({
				method : "POST",
				url : url,
				data : {"csrfmiddlewaretoken" : token},
				datatype : "json",
				success : function(data, status, xhr) {
					if (data.success) {
						if (data.hour_started != 'None') {
							changeBtn("#shift", data.hour_started.substring(0,8));
							shiftStarted = 1;
						}
						for(var i = 0; i < data.breaks.length; i++) {
							if (data.breaks[i][0] != "None") {
								changeBtn("#startBreak" + i, data.breaks[i][0].substring(0, 8));
							}
							if (data.breaks[i][1] != "None") {
								changeBtn("#stopBreak" + i, data.breaks[i][1].substring(0, 8));
								createBtnBreak(i+1);
								item_count++;
							}
						}
						if (data.hour_ended != "None") {
							changeBtn("#stopShift", data.hour_ended.substring(0,8));
							$("#startBreak" + item_count).hide();
							$("#stopBreak" + item_count).hide();
						}
					} else if (data.code == 1) {
						$('#showTimekeeperModal').modal();
						$("#messageTimekeeper").html("There is no shift records for this employee.");
					} else if (data.code == 2) {
							$('#showTimekeeperModal').modal();
							$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if (data.code == 3) {
							$('#showTimekeeperModal').modal();
							$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function startShift(token, url) {
			$.ajax({
				method : "POST",
				url : url,
				data : {"csrfmiddlewaretoken" : token},
				datatype : "json",
				success : function(data, status, xhr) {
					if (data.success) {
						$("#messageTimekeeper").html("Clock-in successful");
						shiftStarted = 1;
						setTimeout(function(){
    						$('#showTimekeeperModal').modal('hide')
						}, 3000);
					} else if (data.code == 1) {
						$("#messageTimekeeper").html("You need to finish the shift you started already before create a new one.");
					} else if (data.code == 2) {
						$("#messageTimekeeper").html("There is no users associated whit this id.");
					} else if (data.code == 3) {
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if (data.code == 4) {
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function startBreak(token, url, breaks) {
			$.ajax({
				method : "POST",
				url : url,
				data : {"csrfmiddlewaretoken" : token},
				datatype : "json",
				success : function(data, status, xhr) {
					if (data.success) {
						alert("success start break");
						alert("breakOrLunch in = " + breakOrLunch);
						if (breakOrLunch == 1) {
							$("#messageTimekeeper").html("Break started");
							breakStarted = 1;
						}
						if (breakOrLunch == 2) {
							$("#messageTimekeeper").html("Lunch started");
							lunchStarted = 1;
						}
						breakStarted = 1;
						lunchStarted = 1;
						setTimeout(function(){
    						$('#showTimekeeperModal').modal('hide')
						}, 3000);
					} else if (data.code == 1) {
						alert("1");
						$("#messageTimekeeper").html("You cannot start 2 breaks at the same time.");
					} else if (data.code == 2) {
						alert("2");
						$("#messageTimekeeper").html("The shift for today was already finished.");
					} else if (data.code == 3) {
						alert("3");
						$("#messageTimekeeper").html("You need to start a shift first.");
					} else if (data.code == 4) {
						alert("4");
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if (data.code == 5) {
						alert("5");
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function stopBreak(token, url, breaks) {
			$.ajax({
				method: "POST",
				url: url,
				data: {"csrfmiddlewaretoken": token},
				datatype: "json",
				success: function(data, status, xhr){
					if(data.success){
						if (breakOrLunch == 1) {
							$("#messageTimekeeper").html("Break ended");
							breakStarted = 0;
						}
						if (breakOrLunch == 2) {
							$("#messageTimekeeper").html("Lunch ended");
							lunchStarted = 0;
						}
						breakStarted = 0;
						lunchStarted = 0;
						setTimeout(function(){
    						$('#showTimekeeperModal').modal('hide')
						}, 3000);
					} else if(data.code == 1){
						$("#messageTimekeeper").html("You need to start a break first.");
					} else if(data.code == 2){
						$("#messageTimekeeper").html("The shift for today was already finished.");
					} else if(data.code == 3){
						$("#messageTimekeeper").html("You need to start a shift first.");
					} else if(data.code == 4){
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if(data.code == 5){
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function stopShift(token, url) {
			$.ajax({
				method: "POST",
				url: url,
				data: {"csrfmiddlewaretoken": token},
				datatype: "json",
				success: function(data, status, xhr){
					if(data.success){
						//$('#signModal').modal("hide");
						//changeBtn("#stopShift", data.hour_ended.substring(11,19));
						$("#startBreak" + item_count).hide();
						$("#stopBreak" + item_count).hide();
						shiftStarted = 0;
					} else if(data.code == 1){
						$("#messageTimekeeper").html("You need to take at least 3 breaks.");
					} else if(data.code == 2){
						$("#messageTimekeeper").html("The shift for today was already finished.");
					} else if(data.code == 3){
						$("#messageTimekeeper").html("You have not started your shift yet.");
					} else if(data.code == 4){
						$("#messageTimekeeper").html("This user is not authorized to use the system.");
					} else if(data.code == 5){
						$("#messageTimekeeper").html("Error. Contact Suport.");
					} else if(data.code == 6){
						$("#messageTimekeeper").html("Error. Contact Suport.");
					}
				}
			});
		}
		function changeBtn(idBtn, hour) {
			if(idBtn.substring(0,11) == "#startBreak"){
				hour_start = hour;
				$(idBtn).attr("value", hour);
				$(idBtn).css('font-size', '20px');
				$(idBtn).css('font-weight', '600');
				$(idBtn).css('font-style', 'italic');
				$(idBtn).css('background', 'url("{% static 'imgSmall/buttons/startShiftHover.png' %}") no-repeat top left');
				$(idBtn).css('background-size', '100% 100%');
			} else if(idBtn.substring(0,10) == "#stopBreak"){
				$("#startBreak" + idBtn.substring(10,11)).attr("value", hour_start);
				$("#startBreak" + idBtn.substring(10,11)).css('background', 'none');
				$("#startBreak" + idBtn.substring(10,11)).css('color', 'black');
				$("#startBreak" + idBtn.substring(10,11)).css('font-size', '20px');
				$("#startBreak" + idBtn.substring(10,11)).css('font-weight', '600');
				$("#startBreak" + idBtn.substring(10,11)).css('font-style', 'italic');
				$("#startBreak" + idBtn.substring(10,11)).css('box-shadow', '0px 0px 10px gray');
				$(idBtn).attr("value", hour);
				$(idBtn).css('background', 'none');
				$(idBtn).css('color', 'black');
				$(idBtn).css('font-size', '20px');
				$(idBtn).css('font-weight', '600');
				$(idBtn).css('font-style', 'italic');
				$(idBtn).css('box-shadow', '0px 0px 10px gray');
			} else {
				$(idBtn).attr("value", hour);
				$(idBtn).css('background', 'none');
				$(idBtn).css('color', 'black');
				$(idBtn).css('font-size', '20px');
				$(idBtn).css('font-weight', '600');
				$(idBtn).css('font-style', 'italic');
				$(idBtn).css('box-shadow', '0px 0px 10px gray');
			}
		}
		function createBtnBreak(count) {
			$( "#divBreaks").append('<div class="row"><div class="col-xs-3 col-md-3 btnColTime"></div><div class="col-xs-2 col-md-2 btnColTime"><input type="button" id="startBreak'+count+'" value="START" class="btnGreenTime btnBreaksGreen"/></div><div class="col-xs-2 col-md-2 btnColTime"></div><div class="col-xs-2 col-md-2 btnColTime"><input type="button" id="stopBreak'+count+'" value="STOP"  class="btnRedTime btnBreaksRed"/></div><div class="col-xs-3 col-md-3 btnColTime"></div></div>');
			$(".btnBreaksGreen").click(function() {
				startBreak("{{ csrf_token }}", "{% url 'startBreak' %}", item_count);
			});
			$(".btnBreaksRed").click(function(){
				stopBreak("{{ csrf_token }}", "{% url 'stopBreak' %}", item_count);
			});
		}
		</script>
	</head>
	<body>
		<header id="head"></header>
		<div id="wrapper">
			<div id="content">
				<div class="namePage">
					<img src="{% static 'imgSmall/iconTimekeeper.png' %}"/>
					{% trans 'HC TIMEKEEPER' %}
				</div>
				
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="shift" value="{% trans 'SHIFT' %}" class="btnsTimekeeper"/>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="break" value="{% trans 'BREAK' %}" class="btnsTimekeeper"/>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="lunch" value="{% trans 'LUNCH' %}" class="btnsTimekeeper"/>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="timelog" value="{% trans 'TIMELOG' %}" class="btnsTimekeeper"/>
					</div>
				</div>
				
				
				
				
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="startBreak0" value="{% trans 'START' %}" class="btnGreenTime btnBreaksGreen"/>
					</div>
					<div class="col-xs-2 col-md-2 btnColTime"></div>
					<div class="col-xs-2 col-md-2 btnColTime">
						<input type="button" id="stopBreak0" value="{% trans 'STOP' %}"  class="btnRedTime btnBreaksRed"/>
					</div>
					<div class="col-xs-3 col-md-3 btnColTime"></div>
				</div>
				<div id="divBreaks"></div>
				<div class="row">
					<div class="col-xs-12 col-md-12">
						<input type="button" id="stopShift" value="{% trans 'END SHIFT' %}"/>
					</div>
				</div>
				
			</div>
		</div>
		<footer>
			&copy;2015 Heavy Connect, Inc.
		</footer>
		<div id="clearBoth"></div>
		<!-- MODAL OF ALERT - TIMEKEEPER -->
		<div class="modal fade" id="showTimekeeperModal" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content modalTimekeeper">
					<div class="modal-body">
						<button type="button" class="closeEquip" data-dismiss="modal"></button>
						<span id="messageTimekeeper"></span>
						<div id="confirmShift"></div>
						<div id="confirmBreak"></div>
						<div id="confirmLunch"></div>
						<br>
						<div class="both"></div>
					</div>
				</div>
			</div>
		</div>
		<div id="clearBoth"></div>
		<!-- MODAL SIGNATURE - TIMEKEEPER -->
		<div class="modal fade" id="signModal" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content signModalDialog">
					<button type="button" class="closeSignature" data-dismiss="modal"></button>
					<div class="modal-title" id="titleSign">{% trans 'Sign Here' %}</div>
					<div class="modal-body" id="signatureContent"">

					<div id="signField" style="margin-top: 100px;">
						<div id="signature"></div>
						<button type="button" id="clearSignature" class="btn btn-default">{% trans 'Limpiar' %}</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cerrar' %}</button>
						<a href="">
							<button type="button" id="stopShiftConfirm" class="btn btn-success">
								{% trans 'Confirmar' %}
							</button>
						</a>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>